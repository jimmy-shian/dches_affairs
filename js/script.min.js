window.onload=function(){toggleSearch()},google.charts.load("current",{packages:["corechart"]});const url_all="https://script.google.com/macros/s/AKfycbwb8zlr3EtkncsWWzOALpAaoxM2dKaK98gntWfRnfrChmvyTTTNrZ3EA3lqv_Dyuigv/exec",gasurlforkey="https://script.google.com/macros/s/AKfycbytSAQbR6zQgu2ceOXmWQpulOG5rIlrCIFFXdwQnabS1Xap7E6tJ62dM4P1eNeKJ_q_/exec",digitMap={10:"一",20:"二",30:"三",40:"四",50:"五",60:"六"};var groupedData,groupedData_table12,groupedData_table3,tables=[3,1];function generateWordDocument(e){let{Document:t,Packer:n,Paragraph:a,ImageRun:l}=docx,i=new t({creator:"你的名字",title:"電費折線圖報告",description:"包含電費折線圖的報告文件",sections:[{children:[new a({text:"電費折線圖報告",heading:"Heading1"}),new a("以下為電費折線圖：\n\n"),new a({children:[new l({data:e,transformation:{width:560,height:350}}),]}),]},]});n.toBlob(i).then(e=>{let t=document.getElementById("download_link");t.setAttribute("href",URL.createObjectURL(e)),t.setAttribute("download","電費折線圖.docx")})}tables.forEach(function(e){$.get(url_all,{table:e},function(t){t&&(console.log(t),3===e?groupedData_table3=t:1===e&&(groupedData_table12=t))}).fail(function(){console.log("fail~"+e)})});var imgURL="";function drawChart(e){var t=e.split("&&"),n=["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"],a=[["月份"]];t.forEach(function(e){var t=e.split(","),l=t.slice(3,15).map(function(e){return""===e?0:parseInt(e)}),i=t[0].match(/^(\d+)年/),r=i?i[0]:"年份資料";a[0].push(r),n.forEach(function(e,t){void 0===a[t+1]&&(a[t+1]=[e]),a[t+1].push(l[t])})});for(var l=google.visualization.arrayToDataTable(a),i=new google.visualization.LineChart(document.getElementById("curve_chart")),r=new google.visualization.NumberFormat({fractionDigits:0,suffix:" 元"}),s=1;s<a[0].length;s++)r.format(l,s);var i=new google.visualization.LineChart(document.getElementById("curve_chart"));google.visualization.events.addListener(i,"ready",function(){var e=i.getImageURI();imgURL=e;var t=document.getElementById("download_link_img");t.setAttribute("href",e),t.textContent="下載 電費折線圖",t.setAttribute("download","chart.png"),t.style.display="block";var t=document.getElementById("download_link");t.textContent="下載電費折線圖（Word）",t.style.display="block",generateWordDocument(imgURL)});var o=document.createElement("div");o.style.position="absolute",o.style.backgroundColor="rgba(0, 0, 0, 0.7)",o.style.color="white",o.style.padding="5px",o.style.borderRadius="5px",o.style.transition="opacity 0.3s",o.style.opacity="0",o.style.pointerEvents="none",o.style.zIndex="9999",document.body.appendChild(o),google.visualization.events.addListener(i,"select",function(e){var t=i.getSelection();if(t.length>0){var s=t[0].row;if(null!==s){for(var d,c=`月份: ${n[s]}
`,p=1;p<a[0].length;p++){c+=`${a[0][p]}: ${r.formatValue(l.getValue(s,p))}
`}o.innerText=c,document.addEventListener("mousemove",function e(t){o.style.left=`${t.pageX+10}px`,o.style.top=`${t.pageY+10}px`}),o.style.opacity="1",setTimeout(()=>{o.style.opacity="0",setTimeout(()=>{o.innerText=""},300)},2e3)}}}),i.draw(l,{title:"全校冷氣 每月電費支出圖",titleTextStyle:{fontSize:24,bold:!0},width:800,height:500,curveType:"none",legend:{position:"bottom"},annotations:{alwaysOutside:!0,textStyle:{fontSize:12,color:"#000000",bold:!0}},pointSize:6,vAxis:{title:"電費 (NT$)",format:"NT$"},hAxis:{title:"月份"},tooltip:{isHtml:!0}})}function handleEnter(e){"Enter"===e.key&&performSearch()}const searchInput=document.getElementById("inputBox"),suggestionsContainer=document.getElementById("suggestions");function updatePlaceholderAndFocus(){let e=document.getElementById("mainDropdown");"3"===e.value?searchInput.placeholder="輸入物品名稱 ex: 筆 釘書機":searchInput.placeholder="輸入班級 ex: 501 四4"}function showAllSuggestions(){suggestionsContainer.innerHTML="";let e=document.getElementById("mainDropdown");if(e.value)for(let t in groupedData="3"===e.value?groupedData_table3:groupedData_table12){let n=document.createElement("div");n.className="group";let a=document.createElement("div");a.className="group-title",a.textContent=t,a.addEventListener("click",()=>{let e=groupedData[t].map(e=>e.name).join(" ");searchInput.value=e,suggestionsContainer.innerHTML=""}),n.appendChild(a),groupedData[t].forEach(e=>{let t=document.createElement("div");t.className="item",t.textContent=e.name,n.appendChild(t),t.addEventListener("click",()=>{searchInput.value=e.name,suggestionsContainer.innerHTML=""})}),suggestionsContainer.appendChild(n)}}function handleInput(){let e=searchInput.value.toLowerCase().trim();if(suggestionsContainer.innerHTML="",!e){showAllSuggestions();return}for(let t in groupedData){let n=groupedData[t].filter(t=>t.name.toLowerCase().includes(e));if(n.length>0){let a=document.createElement("div");a.className="group";let l=document.createElement("div");l.className="group-title",l.textContent=t,a.appendChild(l),n.forEach(e=>{let t=document.createElement("div");t.className="item",t.textContent=e.name,a.appendChild(t),t.onclick=()=>{searchInput.value=e.name,suggestionsContainer.innerHTML=""}}),suggestionsContainer.appendChild(a)}}}function showhide(){let e=document.querySelector(".left-sidebar"),t=document.querySelector(".right-sidebar");document.querySelector("#showhide");let n=document.querySelector(".center-content "),a=document.getElementById("toggleIcon");"none"===e.style.display?(e.style.display="",t.style.display="",setTimeout(function(){n.style.maxWidth="",e.classList.toggle("hidden"),t.classList.toggle("hidden")},200),a.src="https://jimmy-shian.github.io/dches_affairs/images/hide_password.png",a.alt="隱藏導覽列"):(n.style.maxWidth="80%",e.classList.toggle("hidden"),t.classList.toggle("hidden"),setTimeout(function(){e.style.display="none",t.style.display="none"},100),a.src="https://jimmy-shian.github.io/dches_affairs/images/show_password.png",a.alt="顯示導覽列")}function clearSearch(){let e=document.getElementById("searchResult"),t=document.getElementById("text_table");e.innerHTML="",t.innerHTML=""}function toggleSearch(){let e=document.getElementById("searchContainer1"),t=document.getElementById("searchContainer2"),n=document.getElementById("text_table"),a=document.getElementById("curve_chart"),l=document.querySelectorAll(".download_link");"none"===t.style.display?(e.style.display="none",n.style.display="none",t.style.display="flex",a.style.display="",l.forEach(e=>e.style.display="")):(e.style.display="flex",t.style.display="none",a.style.display="none",l.forEach(e=>e.style.display="none"),n.style.display="")}function toggleNav(){let e=document.querySelector(".nav-menu"),t=document.querySelectorAll(".bar");e.classList.toggle("active"),e.classList.contains("active")?(t[0].style.transform="rotate(-45deg) translateY(15px)",t[1].style.opacity="0",t[2].style.transform="rotate(45deg) translateY(-15px)"):(t[0].style.transform="rotate(0) translateY(0)",t[1].style.opacity="1",t[2].style.transform="rotate(0) translateY(0)")}function toggleDropdown(){let e=document.getElementById("customDropdown");e.classList.toggle("open")}function updateButtonText(){let e=document.querySelector(".dropdown-toggle"),t=e.querySelector(".button-text"),n=document.querySelectorAll('.dropdown-options input[type="checkbox"]'),a=[];n.forEach(e=>{e.checked&&a.push(e.parentElement.textContent.trim())}),t.textContent=a.length>0?a.join(", "):"電費年度選擇"}function submitMessage_ebill(e){e.preventDefault();let t=document.querySelectorAll(".dropdown-options input[type='checkbox']:checked"),n=Array.from(t).map(e=>e.value).join(","),a=document.getElementById("searchyearButton");if(a.disabled=!0,!n){alert("請至少選擇一個年度！");return}console.log("selectedYears= "+n+", T= "+typeof n);let l=document.getElementById("searchResult"),i=0,r=setInterval(()=>{i=(i+1)%4,l.innerHTML=`<p>查詢中${".".repeat(i)}</p>`},500);$.post(url_all,{choice:n,cc:n},function(e){if(clearInterval(r),e.success){if(l.innerHTML="",!e.data||0===e.data.length){l.innerHTML=`<p>查詢結束，沒有相關資料	(；д；)。</p>`;return}drawChart(e.data)}else l.innerHTML=`<p>查詢結束，沒有相關資料	(；д；)。</p>`}).fail(function(){let e=document.getElementById("searchResult");e.innerHTML=`<p>連線錯誤，請稍後再試。</p>`}).always(function(){a.disabled=!1})}function performSearch(){let e=document.getElementById("mainDropdown").value;if(!e){alert("選擇搜尋項目~!");return}var t=document.getElementById("inputBox").value;let n=document.getElementById("searchButton");n.disabled=!0,t=(t=t.replace(/\s+/g," ")).replace(/\s+$/,"");let a=url_all,l=document.getElementById("searchResult"),i=document.getElementById("text_table"),r=0,s=setInterval(()=>{r=(r+1)%4,l.innerHTML=`<p>查詢中${".".repeat(r)}</p>`},500);if(document.getElementById("inputBox").value=t,"3"!=e){let o=t.split(" "),d=o.map(e=>{if(/^\d{3}$/.test(e)){let t=parseInt(e.slice(0,2),10),n=digitMap[t]||e.slice(0,2);return n+e[2]}return e});t=(t=d.join(" ")).replace(/\s+$/,""),document.getElementById("inputBox").value=t,$.post(a,{texts:t,table:parseInt(e)},function(e){if(clearInterval(s),e.success){var t;if(!e.data||0===e.data.length){l.innerHTML=`<p>查詢結束，沒有相關資料(˙︿˙)。</p>`;return}let n;i.innerHTML=(t=e.data,n='<table border="1" style="border-collapse: collapse; width: 100%;">',n+=`
                          <thead>
                            <tr>
                              <th style="padding: 8px; text-align: left;">教室位置</th>
                              <th style="padding: 8px; text-align: left;">分機號碼1</th>
                              <th style="padding: 8px; text-align: left;">分機號碼2</th>
                              <th style="padding: 8px; text-align: left;">維修</th>
                            </tr>
                          </thead>
                          <tbody>
                        `,t.forEach(e=>{let[t,a,l]=e.source1.split(",");n+=`
                            <tr>
                              <td style="padding: 8px;">${t}</td>
                              <td style="padding: 8px;">${a}</td>
                              <td style="padding: 8px;">${"無"===l?"--":l}</td>
                              <td style="padding: 8px;">${e.source2.trim().replace(/,$/,"")}</td>
                            </tr>
                          `}),n+="</tbody></table>"),l.innerHTML=`<p>查詢成功！</p>`}else l.innerHTML=`<p>查詢失敗：${e.message}</p>`}).fail(function(){l.innerHTML=`<p>連線錯誤，請稍後再試。</p>`}).always(function(){n.disabled=!1})}else $.post(a,{texts_items:t},function(e){if(clearInterval(s),e.success){var t;if(!e.data||0===e.data.length){l.innerHTML=`<p>查詢結束，沒有相關資料(〒︿〒)。</p>`;return}let n;i.innerHTML=(t=JSON.parse(e.data),n='<table border="1" style="border-collapse: collapse; width: 100%;">',n+=`
                            <thead>
                                <tr>
                                    <th style="padding: 8px; text-align: left;">物品名稱</th>
                                    <th style="padding: 8px; text-align: left;">單位</th>
                                    <th style="padding: 8px; text-align: left;">剩餘數量</th>
                                </tr>
                            </thead>
                            <tbody>
                        `,t.forEach(e=>{n+=`
                                <tr>
                                    <td style="padding: 8px;">${e.itemName}</td>
                                    <td style="padding: 8px;">${e.unit}</td>
                                    <td style="padding: 8px;">${e.remaining}</td>
                                </tr>
                            `}),n+="</tbody></table>"),l.innerHTML=`<p>查詢成功！</p>`}else l.innerHTML=`<p>查詢結束，沒有相關資料(〒︿〒)。</p>`}).fail(function(){let e=document.getElementById("searchResult");e.innerHTML=`<p>連線錯誤，請稍後再試。</p>`}).always(function(){n.disabled=!1})}document.addEventListener("click",e=>{e.target.closest(".suggestions-place")||(suggestionsContainer.innerHTML=""),e.target===overlay&&overlay.classList.add("hidden"),"closeOverlayBtn"===e.target.id&&overlay.classList.add("hidden")}),document.addEventListener("click",function(e){let t=document.getElementById("customDropdown"),n=document.querySelector(".nav-menu"),a=document.querySelector(".hamburger-place");if(t.contains(e.target)||t.classList.remove("open"),!n.contains(e.target)&&!a.contains(e.target)){n.classList.remove("active");let l=document.querySelectorAll(".bar");l[0].style.transform="rotate(0) translateY(0)",l[1].style.opacity="1",l[2].style.transform="rotate(0) translateY(0)"}});const updateDataBtn=document.getElementById("updateDataBtn"),overlay=document.getElementById("overlay"),gotoDriveBtn=document.getElementById("gotoDriveBtn"),postRequestBtn=document.getElementById("postRequestBtn"),closeOverlayBtn=document.getElementById("closeOverlayBtn"),driveUrl="https://drive.google.com/drive/folders/1Kfh9Nb5Lyr8hQM9kfI6X1TKaTNW1QVsT?usp=drive_link";function updateNavigation(e){let t=document.querySelector(".nav-menu"),n=document.querySelector(".left-sidebar"),a=document.querySelector(".right-sidebar");t.innerHTML="",n.innerHTML="",a.innerHTML="";let l=document.createElement("a");l.href="#",l.id="updateDataBtn",l.className="nav-menu-a-special",l.textContent="更新資料",t.appendChild(l);let i=document.createElement("a");i.href="https://drive.google.com/drive/home",i.target="_blank",i.className="sticky-bottom",i.textContent="我的雲端硬碟",a.appendChild(i),e.forEach(function(e){let r=document.createElement("a");r.href=e.url,r.target="_blank",r.textContent=e.name,"nav"===e.position?t.insertBefore(r,l):"left"===e.position?n.appendChild(r):"right"===e.position&&a.insertBefore(r,i)}),document.getElementById("updateDataBtn").addEventListener("click",function(){document.getElementById("overlay").classList.remove("hidden")})}function loadThemePreference(){let e=localStorage.getItem("theme");e&&document.documentElement.setAttribute("data-theme",e),document.getElementById("theme-toggle")?.addEventListener("change",function(){let e=this.checked?"dark":"light";document.documentElement.setAttribute("data-theme",e),localStorage.setItem("theme",e)}),window.addEventListener("DOMContentLoaded",()=>{let e=localStorage.getItem("theme")||"light";document.documentElement.setAttribute("data-theme",e),document.getElementById("theme-toggle").checked="dark"===e})}function bindNavigationControls(){document.getElementById("closeOverlayBtn")?.addEventListener("click",()=>{document.getElementById("overlay").classList.add("hidden")}),document.getElementById("editNavBtn")?.addEventListener("click",()=>{document.getElementById("overlay").classList.add("hidden"),document.getElementById("navEditOverlay").classList.remove("hidden"),loadNavItems()}),document.getElementById("closeNavEditBtn")?.addEventListener("click",()=>{document.getElementById("navEditOverlay").classList.add("hidden")}),document.getElementById("cancelNavChangesBtn")?.addEventListener("click",()=>{document.getElementById("navEditOverlay").classList.add("hidden")}),document.getElementById("addNavItemBtn")?.addEventListener("click",()=>{addNavItem("navItemsContainer")}),document.getElementById("addLeftItemBtn")?.addEventListener("click",()=>{addNavItem("leftItemsContainer")}),document.getElementById("addRightItemBtn")?.addEventListener("click",()=>{addNavItem("rightItemsContainer")}),document.getElementById("saveNavChangesBtn")?.addEventListener("click",()=>{saveNavChanges()}),document.getElementById("postRequestBtn")?.addEventListener("click",()=>{document.getElementById("overlay").classList.add("hidden")})}function loadNavItems(){document.getElementById("navItemsContainer").innerHTML="",document.getElementById("leftItemsContainer").innerHTML="",document.getElementById("rightItemsContainer").innerHTML="",document.querySelectorAll(".nav-menu a:not(.nav-menu-a-special)").forEach(e=>{addNavItem("navItemsContainer",e.textContent,e.href)}),document.querySelectorAll(".left-sidebar a:not(.sticky-bottom)").forEach(e=>{addNavItem("leftItemsContainer",e.textContent,e.href)}),document.querySelectorAll(".right-sidebar a:not(.sticky-bottom)").forEach(e=>{addNavItem("rightItemsContainer",e.textContent,e.href)})}function addNavItem(e,t="",n=""){let a=document.getElementById(e),l=document.createElement("div");l.className="nav-item-input";let i="nav";"leftItemsContainer"===e?i="left":"rightItemsContainer"===e&&(i="right"),l.dataset.position=i,l.innerHTML=`
        <input type="text" class="nav-name-input" placeholder="名稱" value="${t}">
        <input type="text" class="nav-url-input" placeholder="URL" value="${n}">
        <button class="remove-item-btn">刪除</button>
    `,a.appendChild(l),l.querySelector(".remove-item-btn").addEventListener("click",()=>{a.removeChild(l)})}function collectNavItems(e){let t=[];return document.querySelectorAll(`#${e} .nav-item-input`).forEach(e=>{let n=e.querySelector(".nav-name-input").value.trim(),a=e.querySelector(".nav-url-input").value.trim();n&&a&&t.push({name:n,url:a})}),t}function saveNavChanges(){let e=document.getElementById("saveNavChangesBtn"),t=document.getElementById("cancelNavChangesBtn");e.innerHTML='儲存變更 <span class="spinner"></span>',t.innerHTML="取消",document.querySelector(".nav-edit-buttons").classList.add("processing");let n=document.querySelectorAll(".nav-items-container input");n.forEach(e=>e.disabled=!0);let a=document.querySelectorAll("#navEditOverlay button");a.forEach(e=>{e.disabled=!0,e.classList.add("disabled-btn")});let l=collectNavItems("navItemsContainer"),i=collectNavItems("leftItemsContainer"),r=collectNavItems("rightItemsContainer"),s=localStorage.getItem("specialKey");$.post(gasurlforkey,{key:s,action:"updateNavItems",navItems:JSON.stringify(l),leftItems:JSON.stringify(i),rightItems:JSON.stringify(r)},function(l){console.log(l),e.innerHTML="儲存變更",t.innerHTML="取消",document.querySelector(".nav-edit-buttons").classList.remove("processing"),n.forEach(e=>e.disabled=!1),a.forEach(e=>{e.disabled=!1,e.classList.remove("disabled-btn")}),l.success?(alert("導覽列更新成功！"),location.reload()):alert("導覽列更新失敗："+(l.message||"未知錯誤")),document.getElementById("navEditOverlay").classList.add("hidden")}).fail(function(){alert("無法連接到伺服器，請稍後再試。"),e.innerHTML="儲存變更",t.innerHTML="取消",document.querySelector(".nav-edit-buttons").classList.remove("processing"),n.forEach(e=>e.disabled=!1)})}updateDataBtn.addEventListener("click",()=>{overlay.classList.remove("hidden")}),gotoDriveBtn.addEventListener("click",()=>{window.open("https://drive.google.com/drive/folders/1Kfh9Nb5Lyr8hQM9kfI6X1TKaTNW1QVsT?usp=drive_link","_blank"),overlay.classList.add("hidden")}),postRequestBtn.addEventListener("click",()=>{let e=document.getElementById("searchResult");e.innerHTML=`<p>請稍後，更改電話年級名稱 中...</p>`,$.post(url_all,{change_phone:"your_data_here"},function(t){t.success?e.innerHTML=`<p>更改成功，${JSON.stringify(t.data)}</p>`:e.innerHTML=`<p>操作失敗，請稍後再試。</p>`,$.get(url_all,{table:1},function(e){e&&(console.log(e),groupedData_table12=e,showAllSuggestions())}).fail(function(){console.log("fail~"+table)})}).fail(()=>{e.innerHTML=`<p>連線錯誤，請稍後再試。</p>`}),overlay.classList.add("hidden")}),closeOverlayBtn.addEventListener("click",()=>{overlay.classList.add("hidden")}),document.addEventListener("DOMContentLoaded",function(){let e=localStorage.getItem("specialKey"),t=localStorage.getItem("keyExpiry");if(!e||t&&new Date>new Date(new Date(t).getTime()+1728e5)){localStorage.removeItem("specialKey"),localStorage.removeItem("keyExpiry"),window.location.href="index.html";return}$.get(gasurlforkey+"?key="+e,function(e){e.success&&e.navItems?updateNavigation(e.navItems):(localStorage.removeItem("specialKey"),window.location.href="index.html")}).fail(function(){localStorage.removeItem("specialKey"),window.location.href="index.html"}),loadThemePreference(),bindNavigationControls()});