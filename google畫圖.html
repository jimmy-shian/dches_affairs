<html>
<head>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script type="text/javascript">
    google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(drawChart);  <!-- 修正拼写错误 -->

    function drawChart() {
      // 這是您的數據範例
      var rawData = "113年水電瓦斯統計表,8043565034,電費,,,,5142,9059,50401,86728,26597,,,,,,177927,,,";
      
      // 解析數據，將數字提取出來
      var dataArray = rawData.split(',');
      var months = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
      var values = dataArray.slice(3, 15).map(function(value) {
        return value === '' ? 0 : parseInt(value);  // 避免空值
      });
      
      var yearName = dataArray[0].match(/^(\d+)年/); // 正規表達式匹配"XXX年"
          var chartTitle = yearName ? yearName[0] : "年份資料"; // 如果匹配到，則取出年份，否則預設為"年份資料"

        // 創建資料表
      var data = google.visualization.arrayToDataTable([
        ['月份', chartTitle],
        [months[0], values[0]],
        [months[1], values[1]],
        [months[2], values[2]],
        [months[3], values[3]],
        [months[4], values[4]],
        [months[5], values[5]],
        [months[6], values[6]],
        [months[7], values[7]],
        [months[8], values[8]],
        [months[9], values[9]],
        [months[10], values[10]],
        [months[11], values[11]]
      ]);

      // 設定圖表選項
        var options = {
          title: '每月電費支出',
          curveType: 'none',  // 标准折线图
          legend: { position: 'bottom' },
          annotations: {
            alwaysOutside: true,  // 始终显示数据标签
            textStyle: {
              fontSize: 12,
              color: '#000000',  // 设置文本颜色
              bold: true
            }
          },
          pointSize: 6,  // 设置点的大小
          vAxis: {
            title: '電費'
          },
          hAxis: {
            title: '月份'
          }
        };

      // 生成並繪製圖表
      var chart = new google.visualization.LineChart(document.getElementById('curve_chart'));
        
      google.visualization.events.addListener(chart, 'ready', function () {
        // 更新圖片顯示
        var imageUri = chart.getImageURI();

        // 更新下載鏈接的 href 屬性
        var downloadLink = document.getElementById("download_link");
        downloadLink.setAttribute("href", imageUri);
        downloadLink.setAttribute("download", "chart.png");  // 設置下載的文件名
        downloadLink.style.display = "block";  // 顯示下載按鈕
      });
        
      chart.draw(data, options);

    }

  </script>
</head>
<body>
  <div id="curve_chart" style="width: 900px; height: 500px"></div>
    
    <a style="display:none" id="download_link" href="/" download>download</a>

</body>
</html>
